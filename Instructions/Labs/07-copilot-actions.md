---
lab:
  title: エージェント フローを作成する
  module: Enhance Microsoft Copilot Studio agents
---

# エージェント フローを作成する

## シナリオ

この演習では、次のことを行います。

- エージェント フローを作成する

この演習の所要時間は約 **30** 分です。

## 前提条件

- **ラボ: エンティティの使用**を完了している必要があります

## 詳細な手順

## 演習 1 - Dataverse からデータを取得するツールを作成する

Microsoft Copilot Studio では、エージェント フローを使用して Microsoft Dataverse 内のデータにアクセスできます。

### タスク 1.1 - プロパティを取得するエージェント フローを作成する

1. Microsoft Copilot Studio ポータル `https://copilotstudio.microsoft.com` に移動し、適切な環境にあることを確認します。

1. 左側のナビゲーション ウィンドウから **[エージェント]** を選択します。

1. 前のラボで作成した **[不動産予約サービス]** を選択します。

1. **[ツール]** タブを選択します。

1. **[+ ツールを追加する]** を選択します。

1. **[+ 新しいツール]** を選択します。

1. **[エージェント フロー]** を選択します。

1. **[エージェントがフローを呼び出したとき]** のトリガーステップを選択し、**[+ 入力の追加]** を選択します。

1. **[テキスト]** を選択します。

1. **[テキスト]** に「`Bedrooms`」を入力し、**[入力してください]** に「`Number of Bedrooms`」を入力します。

    ![フローのトリガー プロパティのスクリーンショット。](../media/create-flow-step2.png)

1. フロー内の 2 つのステップの間の **+** アイコンを選択し、新しいアクションを追加します。

1. **[検索]** フィールドに「`Dataverse`」と入力し、**Microsoft Dataverse** コネクタの **[詳しく見る]** を選択します。

    ![[フローのコネクタを検索する] のスクリーンショット。](../media/create-flow-step3.png)

1. **[行を一覧にする]** アクションを選択します。

1. アクションの名前を **[List rows]** に変更します。

1. 認証を求められた場合は、**[接続名]** に「`Lab connection`」と入力し、**[認証の種類] に **[OAuth]** を選択して、**[サインイン]** を選択します。

    > **注:** 「**OAuth 接続の作成に失敗しました**」というエラーが表示された場合は、ブラウザーでポップアップを許可する必要があります。

    ![OAuth エラーのスクリーンショット。](../media/failed-oauth-popup.png)

    ![Edge でポップアップを許可するスクリーンショット。](../media/failed-oauth-popup-2.png)

1. テーブル名に **[Real Estate Properties]** テーブルを選択します。

1. **[行のフィルター選択]** フィールドに「`contoso_bedrooms eq `」と入力します (**eq** の後にスペースを入れます)。

1. **[行のフィルター選択]** フィールドを選択したまま、右側にある **[雷]** アイコンを選択し、**[Bedrooms]** パラメーターを選択します。

    ![「行の一覧表示アクションを設定する」のスクリーンショット。](../media/create-flow-step4.png)

    > **重要:** eq と Bedrooms の間にスペースがあることを確認します。

1. 作成キャンバスで **[Respond to the agent]** アクションを選択し、**[+ 出力の追加]** を選択します。

1. **[テキスト]** を選択します。

1. **[名前を入力する]** に「`PropertyId`」を入力する

1. **[応答する値を入力する]** フィールドを選択し、**[fx (式を挿入する)]** を選択します。

1. 一番上のフィールドに、次の式を入力します。

    ```
    first(outputs('List_rows')?['body/value'])['contoso_realestatepropertyid']
    ```

1. **[追加]** を選択します。

1. **+ 出力を追加** を選択します。

1. **[テキスト]** を選択します。

1. **[名前を入力する]** に「`PropertyName`」を入力します。

1. **[応答する値を入力する]** フィールドを選択し、**[fx (式を挿入する)]** を選択します。

1. 次の式を入力します。

    ```
    first(outputs('List_rows')?['body/value'])['contoso_propertyname']
    ```
    ![「応答アクションを設定する」のスクリーンショット。](../media/create-flow-step5.png)

1. **[追加]** を選択します。

1. **[Respond to the agent]** ウィンドウで **[設定]** タブを選択します。

1. **[非同期応答]** が **オフ** に設定されていることを確認します。

    ![[応答アクションの設定] のスクリーンショット。](../media/create-flow-step6.png)

1. ページの右上付近にある **[下書きを保存]** を選択します。

1. **[概要]** タブを選択します。

1. **[詳細]** セクションの **[編集]** を選択します 

1. **[フロー名]** を `Get Property` に更新します

1. **[デザイナー]** タブに戻り、**[公開]** を選択します。 **[エージェント フローが正常に公開されました]** ポップアップで、**[エージェントに戻る]** を選択します。

1. **[エージェント]** を選択し、**[不動産予約サービス]** エージェントを選択します。 

1. **[ツール]** を選択し、作成した [Get Property]フローを追加します。


### タスク 1.2 - [Get Property]ツールをトピックに追加する

1. **[トピック]** タブを選択します。

1. **[不動産の内見の予約]** トピックを選択します。

1. **[寝室はいくつ必要ですか？]** ノードの下にある **+** アイコンを選択し、**[ツールの追加]** を選択してから **[Get Property]** フローを選択します。

1. **Bedrooms** 入力パラメーターの **NumberofBedrooms** 変数を選択します。

    ![[フロー アクションを追加する] の手順 3 のスクリーンショット。](../media/add-action-flow-step-3.png)

1. その下の**[どの物件をご覧になりますか?]** 質問ノードで **3 つのドット**を選択し、**[削除]** を選択します。

1. **[アクション]** ノードの下にある **[+]** アイコンを選択し、**[メッセージを送信する]** を選択します。

1. **[メッセージの入力]** フィールドで「`Property `」と入力します (その後にスペースを付けます)。

1. 同じノードで、 **[{X} (変数の挿入)]** アイコンを選択し、 **PropertyName** 変数を選択します。

    ![[フロー アクションを追加する] の手順 4 のスクリーンショット。](../media/add-action-flow-step-4.png)

1. **[保存]** を選択します。

## 演習 2 - Dataverse でデータを作成するツールを作成する

Microsoft Copilot Studio では、エージェント フローを使用して Microsoft Dataverse 内にデータを作成できます。

### タスク 2.1 - 予約を行うエージェント フローを作成する

1. **不動産予約サービス** の **[ツール]** タブを選択します。

1. **[+ ツールの追加]** を選択します。

1. **[+ 新しいツール]** を選択し、**[エージェント フロー]** を選択します。

1. **[下書きの保存]** を選択し、エージェント フローが保存されるまで待ちます。

1. **[概要]** タブを選択します

1. **[詳細]** セクションの **[編集]** を選択します 

1. `Create Booking Request` に名前を変更します。

1. **[保存]** を選択します。

1. **[デザイナー]** タブを選択します。

1. **[エージェントがフローを呼び出したとき]** のトリガーステップを選択し、**[+ 入力の追加]** を選択します。

1. **[テキスト]** を選択します。

1. **[テキスト]** に「`PropertyId`」を入力し、**[入力してください]** に「`Property`」を入力します。

1. **+ 入力の追加**を選択します。

1. **[テキスト]** を選択します。

1. 「`ViewerName`」と 「`Viewer Name`」を入力します。

1. **+ 入力の追加**を選択します。

1. **[テキスト]** を選択します。

1. 「`ViewerEmail`」と 「`Viewer Email`」を入力します。

    ![「フロー・パラメーター・アクションを設定する」のスクリーンショット。](../media/create-flow2-step1.png)

1. フロー内の 2 つのステップの間の **+** アイコンを選択し、新しいアクションを追加します。

1. **[検索]** フィールドに「`Dataverse`」と入力し、**Microsoft Dataverse** コネクタの **[詳しく見る]** を選択します。

1. **[新しい行を追加する]** アクションを追加します。

1. テーブル名として **[Booking Request]** を選択します。

1. **[Booking Name]** フィールドに「`Agent booking`」と入力します。

1. **詳細パラメーター**で**すべて表示**を選択します。

1. **Property (Real Estate Properties)** フィールドに「`contoso_bookingrequests()`」と入力し、かっこ内にカーソルを移動し、**[雷]** アイコンを選択してから、**PropertyId** パラメーターを選択します。

1. **[Viewer Email]** フィールドを選択し、**[雷]** アイコンを選択してから、**ViewerEmail** パラメーターを選択します。

1. **[Viewer Name]** フィールドを選択し、**[雷]** アイコンを選択してから、**[ViewerName]** パラメーターを選択します。

    ![フローの行の追加アクションの構成のスクリーンショット。](../media/create-flow2-step2.png)

1. **[Respond to Copilot]** アクション選択します。

1. **[設定]** タブを選択します。

1. **[非同期応答]** が **オフ** に設定されていることを確認します。

1. ウィンドウの右上にある **[下書きを保存]** を選択します。

1. 保存が完了するまで待ってから、**[公開]** を選択します。


### タスク 2.2 - ツールを検証する

1. **[エージェント]** を選択し、**[不動産予約サービス]** エージェントを開きます。

1. **[ツール]** タブを選択し、両方のエージェント フローが一覧にあることを確認します。 ない場合は、**[+ ツールの追加]** > **[フロー]** を選択し、**[Create Booking Request]** を選択します。 **[エージェントへの追加]** を選択します。

### タスク 2.3 - [予約リクエストの作成] ツールをトピックに追加する

1. **[トピック]** タブを選択します。

1. **[不動産の内見の予約]** トピックを選択します。

1. **[物件を見学したい日時はいつですか？]** ノードの下にある **+** アイコンを選択し、**[ツールの追加]** を選択してから **[Create Booking Request]** フローを選択します。

1. **PropertyId**入力パラメーターに、**[PropertyId]** 変数を選択します。

1. **ViewerName**入力パラメーターに、**[Name]** 変数を選択します。

1. **ViewerEmail**入力パラメーターに、**[EmailAddress]** 変数を選択します。

1. 新しい **[アクション]** ノードの下にある **[+]** アイコンを選択し、**[トピック管理]** を選択し、**[他のトピックに移動する]** を選択して、**[会話の終了]** を選択します。

1. **[保存]** を選択します。

1. **[公開]** を選択し、もう一度 **[公開する]** を選択します。

## 演習 3 - エージェントをテストする

### タスク 3.1 - 予約要求を行う

1. 閉じている場合は、画面の右上にある **[テスト]** ボタンを選択して、テスト パネルを開きます。

1. 画面の右上にあるテスト パネルの上部にある **3 つのドット**を選択します。

    ![テスト パネル オプションのスクリーンショット。](../media/test-pane-options.png)

1. 有効になっていない場合は、 **[トピック間の追跡]** を有効にします。

1. テスト パネルの上部にある **[新しい会話を開始する]** (更新) アイコンを選択します。

1. **会話の開始**メッセージが表示されたら、エージェントによって会話が開始されます。 応答に、先に作成したトピックのトリガー フレーズを入力します。

    `不動産の内見を予約したい`

1. 名前とメールアドレスを入力します

1. 情報を入力すると、入力した情報がアダプティブ カードに表示され、詳細が正しいかどうかを確認します。 **[はい]** を選択します。

1. プロパティ プロンプトの種類に、**[House]** を選択します。

1. ベッドルーム数に、「`3`」と入力します。

    ![情報が入力されたテスト ウィンドウのスクリーンショット。](../media/test-pane-action-results.png)

1. **"物件を見学したい日時はいつですか？"** プロンプトに、「`明日の 2:00 PM`」と入力します。

1. **"この回答でよろしいでしょうか?"** プロンプトに対して、**[はい]** を選択します。

1. 任意の評価を選択します。

1. **"他に何かお手伝いできますか?"** というプロンプトに対して、**[いいえ]** を選択します。

### タスク 3.2 - 予約要求を確認する

1. まだ開いていない場合は、新しいタブで `https://make.powerapps.com` に移動します。

1. 適切な環境にいることを確認します。

1. 左側のナビゲーションで **[アプリ]** を選択します。

1. モデル駆動型アプリ **Real Estate Property Management** で **[再生]** を選択します。

1. 左側のナビゲーションで **[Booking Requests]** を選択します。 エージェントによって作成された予約リクエストを表示します。

    ![予約要求データを示す Maker ポータルのスクリーンショット。](../media/booking-request-row.png)
